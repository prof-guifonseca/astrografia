// Astrografia üåå ‚Äî N√∫cleo Consolidado v1.8 (HTML direto com GPT-4o)
(() => {
  'use strict';

  const API = {
    generate: '/.netlify/functions/generateMap'
  };

  const $ = selector => document.querySelector(selector);

  const nameEl        = $('#name');
  const dateEl        = $('#birthDate');
  const timeEl        = $('#birthTime');
  const placeEl       = $('#birthPlace');
  const generateBtn   = $('#generateMap');
  const resultSection = $('#result-section');
  const summaryEl     = $('#summary');
  const chartEl       = $('#chart-container');
  const reportEl      = $('#report-container');

  // Requisi√ß√£o ao backend que retorna HTML interpretado
  async function gerarRelatorioHTML(userData) {
    try {
      const res = await fetch(API.generate, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(userData)
      });

      if (!res.ok) {
        const errorText = await res.text();
        console.error('[Astrografia] Erro HTTP:', res.status, errorText);
        throw new Error('Erro na requisi√ß√£o');
      }

      const { summary, htmlReport } = await res.json();
      return { summary, htmlReport };

    } catch (err) {
      console.error('[Astrografia] Erro ao gerar relat√≥rio:', err);
      return {
        summary: '‚ö†Ô∏è Houve uma falha na gera√ß√£o do mapa astral. Tente novamente mais tarde.',
        htmlReport: ''
      };
    }
  }

  // Evento: clique no bot√£o "Gerar Mapa Astral"
  generateBtn.addEventListener('click', async () => {
    const name = nameEl.value.trim();
    const birthDate = dateEl.value;
    const birthTime = timeEl.value;
    const birthPlace = placeEl.value.trim();

    if (!name || !birthDate || !birthTime || !birthPlace) {
      alert('Por favor, preencha todos os campos.');
      return;
    }

    // Estado de carregamento
    generateBtn.disabled = true;
    generateBtn.textContent = 'Gerando...';
    summaryEl.textContent = '‚ú® Conectando com as constela√ß√µes...';
    chartEl.innerHTML = '';
    reportEl.innerHTML = '';
    resultSection.classList.remove('hidden');

    // Gera o relat√≥rio
    const { summary, htmlReport } = await gerarRelatorioHTML({
      name,
      birthDate,
      birthTime,
      birthPlace
    });

    summaryEl.textContent = summary;
    reportEl.innerHTML = htmlReport || '<p>‚ö†Ô∏è Relat√≥rio indispon√≠vel.</p>';

    generateBtn.disabled = false;
    generateBtn.textContent = 'Gerar Mapa Astral';
  });
})();
