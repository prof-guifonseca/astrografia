require('dotenv').config();
const { OpenAI } = require('openai');
const { marked } = require('marked');

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY
});

// üéØ Temas dispon√≠veis para an√°lise
const TEMAS = {
  amor:            'vida amorosa',
  carreira:        'vida profissional',
  familia:         'rela√ß√µes familiares',
  espiritualidade: 'caminho espiritual',
  missao:          'miss√£o de vida',
  desafios:        'desafios e bloqueios pessoais'
};

// üöÄ Fun√ß√£o principal Netlify
exports.handler = async function(event) {
  try {
    const { tema, planetas, nome, ascendant } = JSON.parse(event.body || '{}');

    if (!TEMAS[tema] || !Array.isArray(planetas)) {
      return {
        statusCode: 400,
        body: JSON.stringify({ error: 'Par√¢metros ausentes ou inv√°lidos.' })
      };
    }

    const foco = TEMAS[tema];
    const nomeLimpo = (nome || 'a pessoa').replace(/[^√Ä-≈ø\w \-']/gu, '').trim();

    // üåå Composi√ß√£o do mapa astral para o prompt
    const mapa = planetas
      .map(p => {
        const grau = typeof p.degree === 'number' ? `${p.degree.toFixed(1)}¬∞` : '?¬∞';
        return `${p.icon || 'üîπ'} ${p.name} em ${p.sign} (${grau})`;
      })
      .join(', ');

    const ascText = ascendant
      ? `Ascendente em ${ascendant.sign} (${typeof ascendant.degree === 'number' ? ascendant.degree.toFixed(1) : '?'}¬∞)`
      : '';

    // üß† Prompt bem formatado
    const prompt = `
Voc√™ √© um astr√≥logo experiente, sens√≠vel e respons√°vel. Com base nas posi√ß√µes astrol√≥gicas abaixo, escreva um par√°grafo interpretando o tema "${foco}" para ${nomeLimpo}.

Padr√µes astrais:
${mapa}
${ascText ? '\n' + ascText : ''}

‚Ä¢ Use linguagem acolhedora, clara e motivadora.
‚Ä¢ N√£o use termos t√©cnicos como "quadratura", "casa", "aspecto", etc.
‚Ä¢ Evite clich√™s esot√©ricos e frases gen√©ricas.
‚Ä¢ Mencione o Ascendente como estilo pessoal, se presente.
‚Ä¢ Responda em **1 par√°grafo em Markdown** (sem listas).

Seja objetivo, centrado no contexto astral apresentado, e √∫til para a reflex√£o pessoal.
    `.trim();

    const response = await openai.chat.completions.create({
      model: 'gpt-4o',
      messages: [
        {
          role: 'system',
          content: 'Voc√™ √© um astr√≥logo profissional que escreve com sensibilidade, precis√£o e respeito ao simbolismo astrol√≥gico.'
        },
        { role: 'user', content: prompt }
      ],
      temperature: 0.65,
      max_tokens: 450
    });

    const markdown = response?.choices?.[0]?.message?.content?.trim() || '‚ö†Ô∏è Nenhum conte√∫do gerado.';
    const html = marked.parse(markdown);

    return {
      statusCode: 200,
      body: JSON.stringify({
        html,
        markdown,
        section: foco
      })
    };

  } catch (err) {
    console.error('[Astrografia] Erro na interpreta√ß√£o por se√ß√£o:', err);
    return {
      statusCode: 500,
      body: JSON.stringify({ error: 'Erro interno ao gerar interpreta√ß√£o.' })
    };
  }
};
