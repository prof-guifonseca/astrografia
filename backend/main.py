# -*- coding: utf-8 -*-
import os
import sys
import logging
from datetime import timedelta
from flask import Flask
from flask_cors import CORS
from flask_jwt_extended import JWTManager
from flask_bcrypt import Bcrypt

# dotenv s√≥ em dev/local
if os.environ.get("FLASK_ENV") != "production":
    from dotenv import load_dotenv
    load_dotenv(dotenv_path=os.path.join(os.path.dirname(__file__), ".env"))

# Garante que 'src' est√° no path
sys.path.insert(0, os.path.join(os.path.dirname(__file__), "src"))

# --- Importa√ß√µes locais ---
from src.models.models import db
from src.routes.auth import auth_bp
from src.routes.perspectives import perspectives_bp
from src.routes.astro import astro_bp

# --- Inicializa√ß√£o global do Bcrypt ---
bcrypt = Bcrypt()

def create_app():
    """Factory principal da aplica√ß√£o Flask (Astrografia API)."""
    app = Flask(__name__)

    # Configura√ß√µes b√°sicas
    app.config["SQLALCHEMY_DATABASE_URI"] = os.environ.get("DATABASE_URL", "sqlite:///astrografia.db")
    app.config["SQLALCHEMY_TRACK_MODIFICATIONS"] = False
    app.config["JWT_SECRET_KEY"] = os.environ.get("JWT_SECRET_KEY", "default-dev-secret-key-change-me")
    app.config["JWT_ACCESS_TOKEN_EXPIRES"] = timedelta(hours=1)
    app.config["JWT_REFRESH_TOKEN_EXPIRES"] = timedelta(days=30)

    # Configura√ß√£o de CORS
    cors_origins = os.environ.get("CORS_ORIGINS", "*")
    if cors_origins == "*":
        CORS(app)  # aberto
    else:
        origins = [origin.strip() for origin in cors_origins.split(",")]
        CORS(app, resources={r"/*": {"origins": origins}})

    # Inicializa√ß√µes de extens√£o
    db.init_app(app)
    bcrypt.init_app(app)
    JWTManager(app)

    # Registro das rotas (blueprints)
    app.register_blueprint(auth_bp)
    app.register_blueprint(perspectives_bp)
    app.register_blueprint(astro_bp)

    # Comando para criar as tabelas via CLI
    @app.cli.command("create-db")
    def create_db_command():
        """Cria as tabelas do banco de dados."""
        with app.app_context():
            print("Criando tabelas do banco...")
            db.create_all()
            print("Tabelas criadas com sucesso.")

    # Rota simples de sa√∫de
    @app.route("/")
    def home():
        return "üåå Astrografia API est√° online!"

    return app

# Execu√ß√£o direta (apenas para dev ou Dockerfile local)
if __name__ == "__main__":
    logging.basicConfig(level=logging.INFO)
    app = create_app()
    port = int(os.environ.get("PORT", 5000))
    app.run(debug=False, host="0.0.0.0", port=port)
